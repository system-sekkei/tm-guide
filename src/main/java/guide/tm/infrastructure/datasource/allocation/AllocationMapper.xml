<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="guide.tm.infrastructure.datasource.allocation.AllocationMapper">

    <insert id="register">
        INSERT INTO 引当.引当 (引当番号, 受注番号, 受注明細番号, 商品コード, 倉庫コード, 引当数量)
        VALUES (
                #{allocationId},
                #{salesOrderNumber.value},
                #{salesOrderItemNumber.value},
                #{product.code.value},
                #{allocatedLocation.wareHouseCode.value},
                #{allocatedLocation.allocatedQuantity.value}
               )
    </insert>

    <insert id="recordAllocatedStock">
        INSERT INTO 在庫.引当済在庫 (引当番号, 商品コード, 倉庫コード, 引当数量)
        VALUES (
                #{allocationId},
                #{product.code.value},
                #{allocatedLocation.wareHouseCode.value},
                #{allocatedLocation.allocatedQuantity.value}
               )
    </insert>

    <insert id="registerBundleProduct">
        INSERT INTO 引当.セット商品引当 (引当番号, 受注番号, 受注明細番号, 商品コード, 倉庫コード, 引当数量)
        VALUES (
                   #{allocationId},
                   #{salesOrderNumber.value},
                   #{salesOrderItemNumber.value},
                   #{product.code.value},
                   #{allocatedLocation.wareHouseCode.value},
                   #{allocatedLocation.allocatedQuantity.value}
               )
    </insert>

    <resultMap id="Allocation" type="guide.tm.domain.model.allocation.allocation.Allocation">
        <id property="allocationId.value" column="引当番号"/>
        <result property="salesOrderNumber.value" column="受注番号"/>
        <result property="salesOrderItemNumber.value" column="受注明細番号"/>
        <collection property="allocationContent.allocatedLocations.list"
                    ofType="guide.tm.domain.model.allocation.allocation.AllocatedLocation">
            <result property="wareHouseCode.value" column="倉庫コード"/>
            <result property="allocatedQuantity.value" column="引当数量"/>
        </collection>
    </resultMap>

    <select id="allocationsOf" resultMap="Allocation">
        SELECT
            引当番号,
            受注番号,
            受注明細番号,
            倉庫コード,
            引当数量
        FROM 引当.引当
        WHERE 受注番号 = #{salesOrderNumber.value}
    </select>

    <resultMap id="BundleAllocation" type="guide.tm.domain.model.allocation.allocation.BundleAllocation">
        <result property="salesOrderNumber.value" column="受注番号"/>
        <result property="salesOrderItemNumber.value" column="受注明細番号"/>
        <collection property="allocationContents.list"
                    ofType="guide.tm.domain.model.allocation.allocation.AllocationContent">
            <result property="productCode.value" column="商品コード"/>
            <collection property="allocatedLocations.list" ofType="guide.tm.domain.model.allocation.allocation.AllocatedLocation">
                <result property="wareHouseCode.value" column="倉庫コード"/>
                <result property="allocatedQuantity.value" column="引当数量"/>
            </collection>
        </collection>
    </resultMap>

    <select id="bundleAllocationsOf" resultMap="BundleAllocation">
        SELECT
            引当番号,
            受注番号,
            受注明細番号,
            商品コード,
            倉庫コード,
            引当数量
        FROM 引当.セット商品引当
        WHERE 受注番号 = #{salesOrderNumber.value}
    </select>
</mapper>
